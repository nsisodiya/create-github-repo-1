#!/usr/bin/env bash
set -euo pipefail

branch="$(git rev-parse --abbrev-ref HEAD)"
if [[ "$branch" != "main" ]]; then
  exit 0
fi

if [[ ! -f package.json ]]; then
  echo "pre-push: package.json not found, skipping npm publish."
  exit 0
fi

if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "pre-push: working tree is dirty. Commit or stash changes before push."
  exit 1
fi

pkg_name="$(node -p "require('./package.json').name || ''")"
pkg_version="$(node -p "require('./package.json').version || ''")"

if [[ -z "$pkg_name" || -z "$pkg_version" ]]; then
  echo "pre-push: package.json must include name and version."
  exit 1
fi

published_version="$(npm view "$pkg_name" version 2>/dev/null || true)"
if [[ "$published_version" == "$pkg_version" ]]; then
  echo "pre-push: $pkg_name@$pkg_version already exists on npm."
  echo "Run: npm version patch|minor|major, commit, then push again."
  exit 1
fi

echo "pre-push: publishing $pkg_name@$pkg_version to npm..."
npm publish --access public
echo "pre-push: npm publish completed."
